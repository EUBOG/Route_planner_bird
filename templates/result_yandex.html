{% extends "layout.html" %}

{% block title %}–ú–∞—Ä—à—Ä—É—Ç –ø–æ –¥–æ—Ä–æ–≥–∞–º{% endblock %}

{% block content %}
    <style>
        #map {
            width: 100%;
            height: 600px;
            margin-top: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .info-panel {
            background: white;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 15px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
    </style>

    <!-- –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å —Ä–µ–∂–∏–º–æ–≤ -->
    <div class="btn-group mb-3" role="group">
        <a href="{{ url_for('result', route_id=route.id) }}" class="btn btn-primary">
            üìè –ü–æ –ø—Ä—è–º–æ–π (–ø—Ç–∏—á–∏–π –ø–æ–ª—ë—Ç)
        </a>
        <a href="{{ url_for('result_yandex', route_id=route.id) }}" class="btn btn-success active">
            üõ£Ô∏è –ü–æ –¥–æ—Ä–æ–≥–∞–º (–Ø–Ω–¥–µ–∫—Å)
        </a>
    </div>

    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 25px;">
        <h2>‚úÖ –ú–∞—Ä—à—Ä—É—Ç —Ä–∞—Å—Å—á–∏—Ç–∞–Ω</h2>
        <a href="{{ url_for('index') }}"
           style="background: #6c757d; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px;">
           üîÑ –ù–æ–≤—ã–π –º–∞—Ä—à—Ä—É—Ç
        </a>
    </div>

    <!-- –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ -->
    <div style="background: #e7f3ff; border-left: 5px solid #2196F3; padding: 15px; margin-bottom: 25px; border-radius: 5px;">
        <div style="display: flex; justify-content: space-around; text-align: center;">
            <div>
                <strong>–ù–∞–∑–≤–∞–Ω–∏–µ:</strong><br>
                <span style="font-size: 1.1em;">{{ route.name }}</span>
            </div>
            <div>
                <strong>–¢–æ—á–µ–∫:</strong><br>
                <span style="font-size: 1.1em; color: #667eea; font-weight: bold;">{{ waypoints|length }}</span>
            </div>
            <div>
                <strong>–†–µ–∂–∏–º:</strong><br>
                <span style="font-size: 1.1em; color: #28a745; font-weight: bold;">–ü–æ –¥–æ—Ä–æ–≥–∞–º</span>
            </div>
            <div>
                <strong>–î–∞—Ç–∞:</strong><br>
                <span style="font-size: 0.9em; color: #666;">{{ route.created_at.strftime('%d.%m.%Y %H:%M') }}</span>
            </div>
        </div>
    </div>

    <!-- –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –º–∞—Ä—à—Ä—É—Ç–∞ -->
    <h3 style="margin-bottom: 15px;">üìç –ü–æ—Ä—è–¥–æ–∫ –æ–±—ä–µ–∑–¥–∞:</h3>
    <div style="background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); margin-bottom: 30px;">
        <ol style="padding: 0; margin: 0;">
            {% for waypoint in waypoints %}
                <li style="padding: 15px 20px; border-bottom: 1px solid #eee; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <strong>{{ waypoint.address }}</strong><br>
                        <small style="color: #666;">{{ "%.6f"|format(waypoint.latitude) }}, {{ "%.6f"|format(waypoint.longitude) }}</small>
                    </div>
                    <span style="background: #667eea; color: white; width: 28px; height: 28px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9em;">
                        {{ loop.index }}
                    </span>
                </li>
            {% endfor %}
        </ol>
    </div>

    <!-- –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞ -->
    <h3 style="margin-bottom: 15px;">üó∫Ô∏è –ö–∞—Ä—Ç–∞ –º–∞—Ä—à—Ä—É—Ç–∞:</h3>
    <div id="map"></div>

    <!-- –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ -->
    <div class="info-panel" id="route-info" style="display: none; margin-top: 20px;">
        <h5>üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–∞—Ä—à—Ä—É—Ç–µ:</h5>
        <p><strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> <span id="distance">‚Äî</span></p>
        <p><strong>–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</strong> <span id="duration">‚Äî</span></p>
        <p><strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ—á–µ–∫:</strong> {{ waypoints|length }}</p>
    </div>
{% endblock %}

{% block scripts %}
    <script src="https://api-maps.yandex.ru/2.1/?apikey={{ YANDEX_API_KEY_JS }}&lang=ru_RU" type="text/javascript"></script>
    <script type="text/javascript">
        var waypoints = [
            {% for wp in waypoints %}
            [{{ wp.latitude }}, {{ wp.longitude }}],
            {% endfor %}
        ];

        ymaps.ready(init);

        function init() {
            var myMap = new ymaps.Map("map", {
                center: waypoints[0],
                zoom: 10
            });

            waypoints.forEach(function(point, index) {
                var marker = new ymaps.Placemark(point, {
                    balloonContent: '–¢–æ—á–∫–∞ ' + (index + 1)
                }, {
                    preset: index === 0 ? 'islands#greenDotIcon' :
                           index === waypoints.length - 1 ? 'islands#redDotIcon' :
                           'islands#blueDotIcon'
                });
                myMap.geoObjects.add(marker);
            });

            ymaps.route(waypoints).then(function (route) {
                myMap.geoObjects.add(route);
                myMap.setBounds(route.getBounds(), { checkZoomRange: true });

                var distance = route.getLength();
                var time = route.getHumanJamsTime();

                document.getElementById('distance').textContent = (distance / 1000).toFixed(2) + ' –∫–º';
                document.getElementById('duration').textContent = time.text;
                document.getElementById('route-info').style.display = 'block';

                console.log('–ú–∞—Ä—à—Ä—É—Ç –ø–æ—Å—Ç—Ä–æ–µ–Ω —É—Å–ø–µ—à–Ω–æ!');
            }, function (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∏—è –º–∞—Ä—à—Ä—É—Ç–∞:', error);
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç –ø–æ –¥–æ—Ä–æ–≥–∞–º.');
            });
        }
    </script>
{% endblock %}